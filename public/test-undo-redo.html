<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Undo/Redo System Test</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }

        .container {
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        h1 {
            color: #2c3e50;
            margin-bottom: 10px;
        }

        .status {
            padding: 15px;
            background: #e3f2fd;
            border-left: 4px solid #2196f3;
            margin: 20px 0;
            border-radius: 4px;
        }

        .actions {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }

        button {
            padding: 12px 20px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }

        button:active {
            transform: translateY(0);
        }

        .btn-primary {
            background: #2196f3;
            color: white;
        }

        .btn-success {
            background: #4caf50;
            color: white;
        }

        .btn-warning {
            background: #ff9800;
            color: white;
        }

        .btn-danger {
            background: #f44336;
            color: white;
        }

        .btn-info {
            background: #00bcd4;
            color: white;
        }

        .btn-secondary {
            background: #9e9e9e;
            color: white;
        }

        button.disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .history {
            margin-top: 30px;
        }

        .history-list {
            list-style: none;
            padding: 0;
        }

        .history-item {
            padding: 10px;
            margin: 5px 0;
            background: #f5f5f5;
            border-left: 3px solid #2196f3;
            border-radius: 4px;
        }

        .keyboard-shortcuts {
            margin-top: 30px;
            padding: 20px;
            background: #fff3e0;
            border-radius: 8px;
        }

        .shortcut {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid #ffe0b2;
        }

        .shortcut:last-child {
            border-bottom: none;
        }

        kbd {
            background: #424242;
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-family: monospace;
            font-size: 12px;
        }

        .test-box {
            width: 100px;
            height: 100px;
            background: #2196f3;
            margin: 20px auto;
            border-radius: 8px;
            transition: all 0.3s;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîÑ Undo/Redo System Test Page</h1>
        <p>Test the professional undo/redo system with visual feedback.</p>

        <div class="status" id="status">
            <strong>Status:</strong> <span id="statusText">Initializing...</span>
        </div>

        <div class="test-box" id="testBox"></div>

        <h3>Test Actions</h3>
        <div class="actions">
            <button class="btn-primary" onclick="changeColor()">Change Color</button>
            <button class="btn-success" onclick="changeSize()">Change Size</button>
            <button class="btn-warning" onclick="rotate()">Rotate</button>
            <button class="btn-danger" onclick="reset()">Reset</button>
            <button class="btn-info" id="undoBtn" onclick="testUndo()">‚¨ÖÔ∏è Undo</button>
            <button class="btn-info" id="redoBtn" onclick="testRedo()">‚û°Ô∏è Redo</button>
        </div>

        <div class="keyboard-shortcuts">
            <h4>‚å®Ô∏è Keyboard Shortcuts</h4>
            <div class="shortcut">
                <span>Undo</span>
                <kbd>Ctrl + Z</kbd>
            </div>
            <div class="shortcut">
                <span>Redo</span>
                <kbd>Ctrl + Shift + Z</kbd>
            </div>
            <div class="shortcut">
                <span>Redo (Alternative)</span>
                <kbd>Ctrl + Y</kbd>
            </div>
        </div>

        <div class="history">
            <h3>Action History</h3>
            <ul class="history-list" id="historyList">
                <li class="history-item">No actions yet</li>
            </ul>
        </div>

        <div style="margin-top: 30px; padding: 20px; background: #e8f5e9; border-radius: 8px;">
            <h4>‚úÖ Testing Checklist</h4>
            <ol>
                <li>Click "Change Color" button - box should change color</li>
                <li>Press <kbd>Ctrl+Z</kbd> - color should revert</li>
                <li>Press <kbd>Ctrl+Shift+Z</kbd> - color should change again</li>
                <li>Perform multiple actions and undo them all</li>
                <li>Check that buttons disable when stack is empty</li>
                <li>Verify history updates correctly</li>
            </ol>
        </div>
    </div>

    <!-- Load the actual undo-redo manager -->
    <script src="/frontend/assets/js/undo-redo-manager.js"></script>

    <script>
        // Simple mock viewer for testing
        const mockViewer = {
            scene: { children: [] },
            camera: {},
            renderer: { render: () => {} }
        };

        // Initialize as global viewer
        window.viewerGeneral = mockViewer;

        // Box state
        let boxState = {
            color: '#2196f3',
            size: 100,
            rotation: 0
        };

        // Update visual
        function updateBox() {
            const box = document.getElementById('testBox');
            box.style.background = boxState.color;
            box.style.width = boxState.size + 'px';
            box.style.height = boxState.size + 'px';
            box.style.transform = `rotate(${boxState.rotation}deg)`;
        }

        // Actions
        function changeColor() {
            const colors = ['#2196f3', '#4caf50', '#ff9800', '#f44336', '#9c27b0', '#00bcd4'];
            const oldColor = boxState.color;
            const newColor = colors[Math.floor(Math.random() * colors.length)];
            boxState.color = newColor;
            updateBox();

            // Record action
            if (mockViewer.undoRedoManager) {
                mockViewer.undoRedoManager.recordAction({
                    type: 'Change Color',
                    data: { oldColor, newColor },
                    undo: () => {
                        boxState.color = oldColor;
                        updateBox();
                    },
                    redo: () => {
                        boxState.color = newColor;
                        updateBox();
                    }
                });
                updateHistory();
            }
        }

        function changeSize() {
            const sizes = [80, 100, 120, 140, 160];
            const oldSize = boxState.size;
            const newSize = sizes[Math.floor(Math.random() * sizes.length)];
            boxState.size = newSize;
            updateBox();

            if (mockViewer.undoRedoManager) {
                mockViewer.undoRedoManager.recordAction({
                    type: 'Change Size',
                    data: { oldSize, newSize },
                    undo: () => {
                        boxState.size = oldSize;
                        updateBox();
                    },
                    redo: () => {
                        boxState.size = newSize;
                        updateBox();
                    }
                });
                updateHistory();
            }
        }

        function rotate() {
            const oldRotation = boxState.rotation;
            const newRotation = (oldRotation + 45) % 360;
            boxState.rotation = newRotation;
            updateBox();

            if (mockViewer.undoRedoManager) {
                mockViewer.undoRedoManager.recordAction({
                    type: 'Rotate',
                    data: { oldRotation, newRotation },
                    undo: () => {
                        boxState.rotation = oldRotation;
                        updateBox();
                    },
                    redo: () => {
                        boxState.rotation = newRotation;
                        updateBox();
                    }
                });
                updateHistory();
            }
        }

        function reset() {
            const oldState = { ...boxState };
            boxState = { color: '#2196f3', size: 100, rotation: 0 };
            updateBox();

            if (mockViewer.undoRedoManager) {
                mockViewer.undoRedoManager.recordAction({
                    type: 'Reset',
                    data: { oldState },
                    undo: () => {
                        boxState = { ...oldState };
                        updateBox();
                    },
                    redo: () => {
                        boxState = { color: '#2196f3', size: 100, rotation: 0 };
                        updateBox();
                    }
                });
                updateHistory();
            }
        }

        function testUndo() {
            if (mockViewer.undoRedoManager) {
                mockViewer.undoRedoManager.undo();
                updateHistory();
            }
        }

        function testRedo() {
            if (mockViewer.undoRedoManager) {
                mockViewer.undoRedoManager.redo();
                updateHistory();
            }
        }

        function updateHistory() {
            if (!mockViewer.undoRedoManager) return;

            const state = mockViewer.undoRedoManager.getState();
            const list = document.getElementById('historyList');

            if (state.undoCount === 0 && state.redoCount === 0) {
                list.innerHTML = '<li class="history-item">No actions yet</li>';
                return;
            }

            list.innerHTML = '';

            // Show undo stack
            mockViewer.undoRedoManager.undoStack.forEach((action, i) => {
                const item = document.createElement('li');
                item.className = 'history-item';
                item.innerHTML = `<strong>${i + 1}.</strong> ${action.type}`;
                list.appendChild(item);
            });

            // Show current position
            if (state.redoCount > 0) {
                const current = document.createElement('li');
                current.className = 'history-item';
                current.style.background = '#ffeb3b';
                current.style.borderLeftColor = '#f57c00';
                current.innerHTML = '<strong>‚¨ÖÔ∏è Current Position</strong>';
                list.appendChild(current);

                // Show redo stack
                mockViewer.undoRedoManager.redoStack.slice().reverse().forEach((action, i) => {
                    const item = document.createElement('li');
                    item.className = 'history-item';
                    item.style.opacity = '0.6';
                    item.innerHTML = `<strong>Redo ${i + 1}:</strong> ${action.type}`;
                    list.appendChild(item);
                });
            }

            // Update status
            document.getElementById('statusText').innerHTML = `
                ‚úÖ Ready | Undo: ${state.undoCount} | Redo: ${state.redoCount}
                ${state.lastAction ? ` | Last: ${state.lastAction}` : ''}
            `;
        }

        // Wait for script to load
        setTimeout(() => {
            if (window.initUndoRedoManager) {
                window.initUndoRedoManager(mockViewer);
                document.getElementById('statusText').textContent = '‚úÖ System Ready - Try the buttons!';
                console.log('‚úÖ Test page initialized with undo/redo system');
            } else {
                document.getElementById('statusText').textContent = '‚ùå Undo/Redo system not loaded';
                console.error('‚ùå Undo/Redo manager not found');
            }
        }, 500);
    </script>
</body>
</html>
